<!DOCTYPE html>
<html>
	<body>
		<pre id="result" style="word-wrap: break-word; white-space: pre-wrap;"><br></pre>

		<script type="text/javascript">
			var data = "<?=data?>";
			

			//document.getElementById("result").innerHTML = data;
			data = "#timeofbuild20180726#1. Test conclusion - Pass:\n\t\t2.1.2 Test Result:\n#jira#72#QES00000-24##bugzilla#72#210820##bugzilla#72#211739#"
			
		
            
			var type = {"72":{}, "smoke":{}, "quickreg":{}, "subreg":{}, "finalreg":{}, "newreg":{}, "fullcmd":{}, "resolvebug":{}};
            var total = {"known":{"count":0}, "new":{"count":0}};
			var unfound = [];
            
            
			var time = /#timeofbuild([0-9]+)#/;
			var build_time = time.exec(data)[1];
			jirabug();
			bugfinding();
			if (unfound.length > 0)
            {
                var al = "";
                for(var i in unfound)
                {
                    al += "Bug ID " + unfound[i] + " is not found\n";
                    var pattern = new RegExp("#bugzilla#(.+)#" + unfound[i] + "#");
					var bb = pattern.exec(data);
					if(bb != null)
                    	data = data.replace(bb[0], "");
                }
            	alert(al);
			}
			filldata();
            
            function jirabug()
            {
                var bugs = "";
				for (t in type)
				{
					//type[t]["known"] = type[t]["new"] = 0;

					var pattern = new RegExp("#jira#" + t + "#QES00000\-([0-9]+)#","g");
					var bug;
					while((bug = pattern.exec(data)) != null)
                    {
                        if (bugs == "")
						    bugs += "id=QES00000-" + bug[1];
                        else
                            bugs += "%20or%20id=QES00000-" + bug[1];
                    }
				}
				
				if (bugs.length > 0)
				{
					var x = new XMLHttpRequest();
					x.open("GET", 'https://qnap-jira.qnap.com.tw/rest/api/2/search?jql=' + bugs, false);
					x.open("GET", 'https://qnap-jira.qnap.com.tw/rest/api/2/search?jql=' + bugs, false);
					x.setRequestHeader("Content-Type", "application/json");
					x.setRequestHeader("Accept", "application/json");
                    x.setRequestHeader("Authorization", "Basic emVub3U6d29ya3lvdXJzZWxmdXA");
                    x.setRequestHeader("Access-Control-Allow-Origin", "*");
					x.onreadystatechange = function () {
					  if (x.readyState == 4 && x.status == 200)
					  {
					  	var bugresponse = JSON.parse(this.response);
                        
					  	for (t in type)
						{
							type[t]["known"] = type[t]["new"] = 0;

							var pattern = new RegExp("#jira#" + t + "#QES00000\-([0-9]+)#","g");
							var bb;
							while((bb = pattern.exec(data)) != null)
							{
                            	var found = false;
								for (var r = 0; r < bugresponse["issues"].length; r++)
									if (bugresponse["issues"][r]["key"] == bb[1])
									{
										var bug = type[t];
										var id = bugresponse["issues"][r]["key"];
										bug[id] = {};
										bug[id]["name"] = bugresponse["issues"][r]["summary"];
	
										var create = /([0-9-]+)[a-zA-Z]/;
										bug[id]["time"] = create.exec(bugresponse["issues"][r]["aggregateprogress"]["created"]).split("-").join("");
                                        if(t!="resolvebug")
                                        {
											if(build_time > bug[id]["time"])
											{
						                		total["known"][id] = "Bug " + bugresponse["issues"][r]["key"] + " - " + bugresponse["issues"][r]["summary"];
						                		total["known"]["count"] += 1;
												bug["known"] += 1;
												bug[id]["known"] = true;
											}
											else
											{	
						                		total["new"][id] = "Bug " + bugresponse["issues"][r]["key"] + " - " + bugresponse["issues"][r]["summary"];
						                		total["new"]["count"] += 1;
												bug["new"] += 1;
												bug[id]["known"] = false;
											}
                                        }
                                        found = true;
										break;
									}
                            	if (found == false)
                                	unfound.push(bb[1]);
							}
						}

					  }
					};
					x.send();
				}
            }

			function bugfinding()
			{	
				var bugs = "";
				for (t in type)
				{
					//type[t]["known"] = type[t]["new"] = 0;

					var pattern = new RegExp("#bugzilla#" + t + "#([0-9]+)#","g");
					var bug;
					while((bug = pattern.exec(data)) != null)
						bugs += bug[1] + ",";
				}
				
				if (bugs.length > 0)
				{
					bugs = bugs.substring(0, bugs.length - 1);
					var x = new XMLHttpRequest();
					x.open("GET", 'https://bugzilla.qnap.com.tw/rest/bug?id=' + bugs + '&api_key=MCL0MSBYlkNJRIylvMBqRzSXDOdHmwERgmuYRrrQ', false);
					x.setRequestHeader("Content-Type", "application/json");
					x.setRequestHeader("Accept", "application/json");
					x.onreadystatechange = function () {
					  if (x.readyState == 4 && x.status == 200)
					  {
					  	var bugresponse = JSON.parse(this.response);
                        
					  	for (t in type)
						{
							type[t]["known"] = type[t]["new"] = 0;

							var pattern = new RegExp("#bugzilla#" + t + "#([0-9]+)#","g");
							var bb;
							while((bb = pattern.exec(data)) != null)
							{
                            	var found = false;
								for (var r = 0; r < bugresponse["bugs"].length; r++)
									if (bugresponse["bugs"][r]["id"] == bb[1])
									{
										var bug = type[t];
										var id = bugresponse["bugs"][r]["id"];
										bug[id] = {};
										bug[id]["name"] = bugresponse["bugs"][r]["summary"];
	
										var create = /([0-9-]+)[a-zA-Z]/;
										bug[id]["time"] = create.exec(bugresponse["bugs"][r]["creation_time"])[1].split("-").join("");

										if(build_time > bug[id]["time"])
										{
						                	total["known"][id] = bugresponse["bugs"][r]["summary"];
						                	total["known"]["count"] += 1;
											bug["known"] += 1;
											bug[id]["known"] = true;
										}
										else
										{	
						                	total["new"][id] = bugresponse["bugs"][r]["summary"];
						                	total["new"]["count"] += 1;
											bug["new"] += 1;
											bug[id]["known"] = false;
										}
                                        found = true;
										break;
									}
                            	if (found == false)
                                	unfound.push(bb[1]);
							}
						}

					  }
					};
					x.send();
				}

			}

			
			async function wait()
			{ 
				while(async_count > 0)
					await sleep(100);
                filldata();
                //alert("Done");
            }

			function sleep(ms) {
			  return new Promise(resolve => setTimeout(resolve, ms));
			}

			function requestbug(t, bug)
			{
				type[t][bug[1]] = {};

				var x = new XMLHttpRequest();
				x.open("GET", 'https://bugzilla.qnap.com.tw/rest/bug/' + bug[1], true);
				x.setRequestHeader("Content-Type", "application/json");
				x.setRequestHeader("Accept", "application/json");
				x.onreadystatechange = function () {
				  if (x.readyState == 4 && x.status == 200)
				  {
				  	refix(this, type[t], bug[1], t);
				  }
				};
				x.send();
			}

			function refix(xhttp, bug, id, type)
			{
				//alert(id);
				var summary = /"summary":"([^"]+)","is_open"/;
				var name = summary.exec(xhttp.response);
				bug[id]["name"] = name[1];

				var create = /"creation_time":"([0-9-]+)[^"]+","qa_contact"/;
				bug[id]["time"] = create.exec(xhttp.response)[1].split("-").join("");
				
				
				if(build_time > bug[id]["time"])
				{
                	total["known"][id] = name[1];
                	total["known"]["count"] += 1;
					bug["known"] += 1;
					bug[id]["known"] = true;
				}
				else
				{	
                	total["new"][id] = name[1];
                	total["new"]["count"] += 1;
					bug["new"] += 1;
					bug[id]["known"] = false;
				}

				async_count -= 1;
				//document.getElementById("result").innerHTML = xhttp.response;
			}


			function filldata()
			{
				for (t in type)
				{
					var sumtext = "Fail - ";
					if (Object.keys(type[t]).length > 0)
					{
						if (type[t]["new"] > 0)
							sumtext += ("Total " + type[t]["new"] + " new issues, ")
						if (type[t]["known"] > 0)
						{
							if (sumtext.length > 0)
								sumtext += ("and " + type[t]["known"] + " known issues")
							else
								sumtext += ("Total " + type[t]["known"] + " known issues")
						}
						else if (sumtext.length > 0)
							sumtext = sumtext.substring(0, sumtext.length - 2);

						sumtext += " found in this test cycle";

						var buglist = "Fail with " + type[t]["known"] + " known issuses and " + type[t]["new"] + " new issuses.\n";
						if (type[t]["new"] > 0)
						{	
							buglist += ("\t\t\t" + type[t]["new"] + " new issuses:\n");
							for (id in type[t])
								if (!type[t][id]["known"] && id != "new" && id != "known")
									buglist += ("\t\t\t\tBug " + id + " - " + type[t][id]["name"] + "\n");
						}
						if (type[t]["known"] > 0)
						{
							buglist += ("\t\t\t" + type[t]["known"] + " known issuses:\n");
							for (id in type[t])
								if (type[t][id]["known"] && id != "new" && id != "known")
									buglist += ("\t\t\t\tBug " + id + " - " + type[t][id]["name"] + "\n");
						}

						data = data.replace("#testresult#" + t + "#", sumtext);

						for (id in type[t])
						{
							data = data.replace("#bugzilla#" + t + "#" + id + "#", buglist);
							buglist = "";
						}
						//data = data.replace("#bugzilla#" + type + "#" + id + "#", bug["name"]);
					}
					//Pass write on server
				}
                data = data.replace("#timeofbuild" + build_time + "#", "");
                
                if (total["known"]["count"] == 0 && total["known"]["count"] == 0)
                	data = data.replace("#bugzilla#reg#", "Total 0 issues");
                else
                {
                	var sum_total = "";
                	if (total["known"]["count"] > 0)
                		sum_total = "Total " + total["known"]["count"] + " known issues";
                	if (total["new"]["count"] > 0)
                		if (sum_total.length > 0)
                			sum_total += ", " + total["new"]["count"] + " new issues";
                		else
                			sum_total = "Total " + total["new"]["count"] + " new issues";
                	sum_total += "\n\t\t4.0.1 Bug list:\n\t\t\t";
                	if (total["known"]["count"] > 0)
                	{
                		sum_total += total["known"]["count"] + " known issues:\n\t\t\t\t";
                		for (id in total["known"])
                			if (id != "count")
                				sum_total += total["known"][id] + "\n\t\t\t\t";
                		sum_total = sum_total.substring(0, sum_total.length - 1);
                	}
                	if (total["new"]["count"] > 0)
                	{
                		sum_total += total["new"]["count"] + " known issues:\n\t\t\t\t";
                		for (id in total["new"])
                			if (id != "count")
                				sum_total += total["new"][id] + "\n\t\t\t\t";
                		sum_total = sum_total.substring(0, sum_total.length - 4);
                	}
                    data = data.replace("#bugzilla#reg#", sum_total);
                }
                
                document.getElementById("result").innerText = data;
                document.getElementById("result").addEventListener("click", copy);
			}

			function copy() {
			    var el = document.createElement('textarea');
  				el.value = document.getElementById("result").innerText;
				document.body.appendChild(el);
				el.select();
				document.execCommand('copy');
				document.body.removeChild(el);
			}
	    </script>

	</body>
</html>